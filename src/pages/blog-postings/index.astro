---
import { getCollection, getEntries, getEntry } from 'astro:content'
import Layout from '@layouts/layout.astro'
import BlogPostingList from '@components/blog-postings/blog-posting-list.astro'
import KeywordList from '@components/blog-postings/keywords/keyword-list.astro'
import Section from '@components/layouts/section.astro'
import Stack from '@components/layouts/stack.astro'
import Heading from '@components/ui/heading.astro'
import Text from '@components/ui/text.astro'
import Anchor from '@components/ui/anchor.astro'
import {
  aggregateKeywordUsages,
  buildBlogJsonLd,
  createPublishedFilter,
  sortBlogPostingsByDate,
} from '@lib/content'
import type { BlogJsonLdResult } from '@lib/content'

const now = Date.now()
const publishedFilter = createPublishedFilter(now)
const blogPostings = sortBlogPostingsByDate(await getCollection('blog-postings', publishedFilter))
const blogSchemaEntry = await getEntry('blogs', 'blog')

if (!blogSchemaEntry) {
  throw new Error('Blog schema entry not found')
}

const resolvedBlogPostings = await Promise.all(
  blogPostings.map(async (posting) => ({
    entry: posting,
    authors: await getEntries(posting.data.author),
    keywords: await getEntries(posting.data.keywords),
  }))
)

const { keywords, blogJsonLd }: BlogJsonLdResult = buildBlogJsonLd(
  blogSchemaEntry,
  resolvedBlogPostings
)

const keywordUsageCounts = Object.fromEntries(
  aggregateKeywordUsages(resolvedBlogPostings.map((posting) => posting.keywords)).map(
    ({ keyword, usageCount }) => [keyword.id, usageCount] as const
  )
)

const blogPostingKeywordMap = Object.fromEntries(
  resolvedBlogPostings.map(({ entry, keywords }) => [entry.id, keywords] as const)
)
---

<Layout
  title={blogSchemaEntry.data.name}
  description={blogSchemaEntry.data.description}
  ogImagePath="/open-graph/blog-postings.png"
>
  <script type="application/ld+json" is:inline set:html={JSON.stringify(blogJsonLd)} />

  <Section paddingX="sm" paddingY="xl" paddingYAtSm="2xl">
    <Stack direction="row" justify="center" width="full">
      <Stack direction="column" width="full" maxWidth="4xl" gap="md">
        <Text
          as="p"
          size="xs"
          tone="subtle"
          weight="semibold"
          tracking="wide"
          transform="uppercase"
          leading="snug"
        >
          Blog Postings
        </Text>
        <Heading level={1} size="2xl" sizeAtSm="3xl" weight="semibold">
          Essays &amp; dispatches
        </Heading>
        <Text tone="muted" size="base" sizeAtSm="lg">
          Systems thinking riffs, architecture deep dives, and lessons from building for people at
          scale.
        </Text>
      </Stack>
    </Stack>
  </Section>

  <Section tone="page" paddingX="sm" paddingY="lg" paddingYAtSm="2xl">
    <Stack direction="row" justify="center" width="full">
      <Stack direction="column" width="full" maxWidth="4xl" gap="2xl">
        <BlogPostingList
          blogPostings={blogPostings}
          emptyMessage="No blog postings found."
          keywordMap={blogPostingKeywordMap}
        >
          <Anchor slot="empty-action" href="/blog-postings" size="sm" weight="semibold">
            Browse archive
          </Anchor>
        </BlogPostingList>

        <KeywordList keywords={keywords} usageCounts={keywordUsageCounts} />
      </Stack>
    </Stack>
  </Section>
</Layout>
